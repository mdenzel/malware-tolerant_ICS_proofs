#!/bin/bash

#
#  @title:    Self-healing Industrial Control System
#  @authors:  Michael Denzel <research@michael-denzel.de>
#  @date:     2016-07-14
#
#  Shellscript to generate and run ProVerif proofs for Smart-Guard
#

### CONFIG ###
# (please alter this section as needed)
#proof generation
ONLY_GENERATE=0          #set to 1 to only generate proofs without executing them
FORCE_GENERATION=0       #set to 1 to enforce proof generation each time (not needed for ONLY_GENERATE)
CLEANUP=0                #set to 1 to enforce cleaning up the generated files after running (ignored for ONLY_GENERATE)
##############

#check that proverif and cpp (c-pre-processor) are installed
type proverif >/dev/null 2>&1 || { echo >&2 "Could not locate ProVerif. Aborting..." && exit -1; }
type cpp >/dev/null 2>&1 || { echo >&2 "Could not locate C-pre-processor (needed for proof generation). Aborting..." && exit -1; }

# ------------ Generate proofs -----------------

#check if generation is enforced or not all proofs exist
if [ $FORCE_GENERATION -eq 1 ] || [ $ONLY_GENERATE -eq 1 ] ||
       [ ! -d ./proofs/selfhealing_proverif.gen ]
then
    #generate proofs for self-healing ICS
    cd ./proofs
    ./generate.sh
    #go back to main directory
    cd ..
    
    #exit if only generation was requested
    if [ $ONLY_GENERATE -eq 1 ]; then
        exit 0
    fi
fi

# ------------ Run proofs -----------------
cd ./proofs

#execute
echo -e "\n--- Self-healing Industrial Control System Proofs ---"
sh ./run.sh ./proofs-selfhealing_proverif.gen
echo -e "\n\n======================================\n"

#go back to main directory
cd ..

# ------------ CLEANUP -----------------

if [ $CLEANUP -eq 1 ]; then
    echo -en "\nClean up: "
    rm -r ./proofs-selfhealing_proverif.gen
    if [ $? -eq 0 ]; then
        echo "success"
    else
        echo "failed"
    fi
fi
